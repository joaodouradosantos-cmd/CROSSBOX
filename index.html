<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Cross Moita - Di√°rio de Treino Offline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1f14">

  <!-- Manifesto PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="imagens/crossbox_logo.png" type="image/png">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    body {
      background:
        /* RISCOS ESCUROS TIPO ARRANH√ïES */
        repeating-linear-gradient(
          145deg,
          rgba(18, 22, 15, 0.95) 0px,
          rgba(18, 22, 15, 0.95) 120px,
          rgba(12, 13, 10, 1) 121px,
          rgba(12, 13, 10, 1) 132px
        ),
        /* MANCHAS OLIVA / LAMA */
        radial-gradient(circle at 12% 0%, rgba(116, 128, 76, 0.55) 0, transparent 55%),
        radial-gradient(circle at 85% 100%, rgba(140, 110, 60, 0.45) 0, transparent 60%),
        /* FUNDO PRINCIPAL VERDE TROPA ESCURO */
        linear-gradient(to bottom, #4f5b32 0%, #262f1c 40%, #141710 100%);

      color: #f7f7f2;
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      padding: 16px 8px;
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(180deg,
        rgba(21, 24, 16, 0.96) 0%,
        rgba(20, 22, 15, 0.98) 40%,
        rgba(14, 15, 10, 0.99) 100%);
      border-radius: 16px;
      padding: 12px 12px 16px 12px;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.8),
        0 20px 40px rgba(0, 0, 0, 0.85);
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 10% 20%, rgba(140, 160, 90, 0.20) 0, transparent 55%),
        radial-gradient(circle at 85% 20%, rgba(180, 140, 80, 0.17) 0, transparent 60%),
        radial-gradient(circle at 50% 100%, rgba(80, 90, 60, 0.4) 0, transparent 55%);
      mix-blend-mode: soft-light;
      opacity: 0.9;
      pointer-events: none;
      z-index: 0;
    }

    .app-inner {
      position: relative;
      z-index: 1;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      position: relative;
    }

    #appLogo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow:
        0 0 0 2px rgba(0, 0, 0, 0.9),
        0 0 12px rgba(0, 0, 0, 0.8);
    }

    .subtitle {
      font-size: 0.85rem;
      color: #c1c7b5;
      margin-top: 2px;
    }

    h1 {
      font-size: 1.3rem;
      margin: 0;
      color: #f5f7ed;
      letter-spacing: 0.03em;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    }

    h2 {
      font-size: 0.9rem;
      margin: 0 0 4px 0;
      color: #e0e3d2;
    }

    h3 {
      font-size: 0.9rem;
      margin-top: 0;
      color: #e2e6d4;
    }

    .card {
      background:
        radial-gradient(circle at 0 0, rgba(160, 150, 90, 0.18) 0, transparent 55%),
        radial-gradient(circle at 100% 0, rgba(120, 150, 105, 0.18) 0, transparent 60%),
        linear-gradient(135deg, rgba(26, 30, 20, 0.96), rgba(16, 18, 11, 0.98));
      border-radius: 12px;
      padding: 10px;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.85),
        0 12px 24px rgba(0, 0, 0, 0.9);
      margin-bottom: 10px;
    }

    .card.highlight {
      border: 1px solid rgba(206, 186, 110, 0.85);
      box-shadow:
        0 0 0 1px rgba(206, 186, 110, 0.6),
        0 14px 28px rgba(0, 0, 0, 0.95);
    }

    label {
      font-size: 0.75rem;
      color: #d7dcc7;
      display: block;
      margin-bottom: 2px;
    }

    input, select, textarea {
      width: 100%;
      padding: 6px 7px;
      border-radius: 6px;
      border: 1px solid rgba(92, 98, 80, 0.85);
      background: rgba(10, 12, 7, 0.94);
      color: #f5f5ed;
      font-size: 0.8rem;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.8);
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(207, 191, 120, 0.95);
      box-shadow:
        0 0 0 1px rgba(207, 191, 120, 0.7),
        0 0 0 3px rgba(207, 191, 120, 0.25);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .field {
      flex: 1;
      min-width: 90px;
    }

    .field-small {
      max-width: 120px;
    }

    .inline-field {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .inline-field span.value {
      font-weight: 600;
      color: #f3f3e4;
      font-size: 0.9rem;
    }

    .helper-text {
      font-size: 0.72rem;
      color: #b7bca8;
      margin-top: 2px;
    }

    .helper-text strong {
      color: #f0f2e5;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 4px 0 10px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(117, 129, 94, 0.85);
      background: radial-gradient(circle at 0 0, rgba(150, 170, 90, 0.25) 0, transparent 60%);
      color: #f4f4ea;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.7);
    }

    .tab-btn span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tab-btn:hover {
      filter: brightness(1.06);
    }

    .tab-btn.active {
      background:
        linear-gradient(135deg, #cfc27a, #f0df9e);
      color: #16170e;
      border-color: #e2d58d;
      box-shadow:
        0 0 0 1px rgba(6, 5, 0, 0.8),
        0 3px 0 rgba(6, 5, 0, 0.95);
    }

    .tab-btn.active span {
      font-weight: 600;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    button {
      font-family: inherit;
    }

    .btn-primary {
      background: linear-gradient(135deg, #d9c877, #f5e59a);
      color: #15140b;
      border-radius: 999px;
      border: 1px solid #f0e2a0;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.7),
        0 3px 0 rgba(0, 0, 0, 0.9);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-secondary {
      background: radial-gradient(circle at 0 0, rgba(150, 167, 92, 0.25) 0, transparent 60%);
      color: #f0f3e5;
      border-radius: 999px;
      border: 1px solid rgba(110, 120, 85, 0.85);
      padding: 6px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      box-shadow: 0 2px 0 rgba(0, 0, 0, 0.7);
      white-space: nowrap;
    }

    .btn-secondary:hover {
      filter: brightness(1.06);
    }

    .btn-ghost {
      background: transparent;
      color: #d7dcc7;
      border-radius: 999px;
      border: 1px dashed rgba(113, 120, 92, 0.7);
      padding: 4px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-ghost:hover {
      border-style: solid;
      filter: brightness(1.08);
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.72rem;
    }

    .btn-danger {
      background: linear-gradient(135deg, #a13f32, #c74a3a);
      border-color: #f2b7a5;
      color: #fff4ee;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at 0 0, rgba(180, 165, 100, 0.5) 0, transparent 55%);
      border-radius: 999px;
      border: 1px solid rgba(188, 173, 105, 0.95);
      padding: 4px 8px;
      font-size: 0.7rem;
      color: #f7f7e9;
    }

    .badge span.value {
      font-weight: 700;
      font-size: 0.8rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at 0 0, rgba(110, 125, 72, 0.6) 0, transparent 55%);
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 0.7rem;
      color: #f3f5e8;
      border: 1px solid rgba(131, 145, 88, 0.9);
    }

    .chip span.label {
      opacity: 0.9;
    }

    .chip span.value {
      font-weight: 600;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.72rem;
      color: #c4c9b4;
    }

    .toggle-row label {
      margin: 0;
      font-size: 0.72rem;
      color: #cfd4c0;
    }

    .toggle-row input[type="checkbox"] {
      width: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: #f1f3e7;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(83, 88, 64, 0.85);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #c8ceb8;
    }

    tr:nth-child(even) td {
      background: rgba(8, 10, 5, 0.7);
    }

    tr:nth-child(odd) td {
      background: rgba(12, 13, 7, 0.85);
    }

    td span.tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(132, 145, 87, 0.35);
      border: 1px solid rgba(140, 153, 92, 0.8);
    }

    .scroll {
      overflow-x: auto;
      margin-top: 4px;
    }

    .small-text {
      font-size: 0.7rem;
      color: #c4c9b4;
    }

    .warning {
      background: rgba(150, 100, 40, 0.3);
      border: 1px solid rgba(200, 150, 80, 0.85);
      color: #f7f0df;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }

    .success {
      background: rgba(110, 150, 80, 0.3);
      border: 1px solid rgba(155, 200, 110, 0.85);
      color: #f4f8ea;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .alert {
      background: rgba(150, 70, 60, 0.38);
      border: 1px solid rgba(210, 120, 100, 0.9);
      color: #ffece6;
      padding: 6px 8px;
      border-radius: 8px;
      font-size: 0.75rem;
      margin-top: 6px;
    }

    canvas {
      max-width: 100%;
    }

    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
      }

      .options-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      header {
        align-items: flex-start;
      }

      #appLogo {
        width: 54px;
        height: 54px;
      }

      h1 {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-inner">
  <header>
    <img id="appLogo" src="imagens/crossbox_logo.png" alt="Cross Moita Logo">
    <div>
      <h1>CrossBox - Di√°rio de Treino</h1>
      <div class="subtitle" id="appSubtitle">Registo de treinos</div>
    </div>
  </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Nome</label>
          <input id="nome" type="text" placeholder="O teu nome ou nickname" />
        </div>
        <div class="field">
          <label>N√≠vel atual</label>
          <select id="nivel">
            <option value="">Seleciona</option>
            <option value="iniciado">Iniciado</option>
            <option value="intermedio">Interm√©dio</option>
            <option value="avancado">Avan√ßado</option>
            <option value="competidor">Competidor</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Seleciona</option>
            <option value="masculino">Masculino</option>
            <option value="feminino">Feminino</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="99" placeholder="Anos" />
        </div>
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="100" max="230" placeholder="Ex.: 175" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" min="30" max="200" step="0.1" placeholder="Ex.: 78.5" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Box / local de treino</label>
          <input id="box" type="text" placeholder="Ex.: CrossFit Moita, garagem, parque..." />
        </div>
        <div class="field">
          <label>Objetivo principal</label>
          <input id="objetivoPrincipal" type="text" placeholder="Ex.: for√ßa, performance, perda de peso..." />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Observa√ß√µes pessoais</label>
          <input id="observacoes" type="text" placeholder="Notas r√°pidas sobre les√µes, limita√ß√µes, etc." />
        </div>
      </div>

      <button class="btn-primary" id="saveProfile">Guardar perfil</button>
    </div>
  </section>

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-1rm">
      <span>1RM</span>
    </button>
    <button class="tab-btn" data-target="sec-opcoes">
      <span>WOD &amp; Tools</span>
    </button>
  </div>

  <!-- SEC√á√ÉO 1: 1RM -->
  <section id="sec-1rm" class="section active">
    <div class="card highlight">
      <h2>üß± C√°lculo de 1RM e percentagens</h2>
      <div class="helper-text">
        Introduz o teu 1RM em cada movimento para ver automaticamente as percentagens mais usadas nos treinos.
      </div>

      <div class="form-row">
        <div class="field">
          <label>Exerc√≠cio</label>
          <select id="rmExercicio"></select>
        </div>
        <div class="field">
          <label>1RM (kg)</label>
          <input id="rmValor" type="number" min="0" step="0.5" placeholder="Ex.: 120" />
        </div>
        <div class="field field-small">
          <label>&nbsp;</label>
          <button class="btn-primary btn-small" id="rmAdd">Guardar 1RM</button>
        </div>
      </div>

      <div class="helper-text">
        <strong>Dica:</strong> atualiza o 1RM sempre que fizeres um novo m√°ximo. O hist√≥rico ajuda-te a ver a evolu√ß√£o.
      </div>
    </div>

    <div class="card" id="rmAtualCard" style="display:none;">
      <div class="form-row">
        <div class="field">
          <label>Resumo do teu 1RM</label>
          <div id="rmResumo" class="small-text"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Tabela de percentagens</h3>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>25%</th>
              <th>30%</th>
              <th>35%</th>
              <th>40%</th>
              <th>50%</th>
              <th>60%</th>
              <th>65%</th>
              <th>70%</th>
              <th>75%</th>
              <th>80%</th>
              <th>85%</th>
              <th>90%</th>
              <th>95%</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="helper-text" id="rmHelper">
        Usa esta tabela para ajustar rapidamente as cargas nos WODs, sem ter de fazer contas de cabe√ßa.
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Hist√≥rico de 1RM</h3>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Exerc√≠cio</th>
              <th>1RM</th>
              <th>Coment√°rio</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rmHistoryBody"></tbody>
        </table>
      </div>
      <div class="helper-text">
        Mant√©m registo dos teus m√°ximos ao longo do tempo. Pequenas melhorias acumuladas fazem grande diferen√ßa.
      </div>
    </div>
  </section>

  <!-- SEC√á√ÉO 2: WOD & TOOLS -->
  <section id="sec-opcoes" class="section">

    <div class="card">
      <div class="options-grid">
        <button class="btn-secondary opt-btn" data-target="opt-wod">
          <span class="opt-emoji">üü©</span>
          <span>WOD</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-calc">
          <span class="opt-emoji">üßÆ</span>
          <span>Objetivo</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-graficos">
          <span class="opt-emoji">üìà</span>
          <span>Gr√°fico</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-performance">
          <span class="opt-emoji">üèÖ</span>
          <span>Desempenho</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-reservas">
          <span class="opt-emoji">üìÜ</span>
          <span>Marca√ß√µes</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-guia">
          <span class="opt-emoji">üìö</span>
          <span>Exerc√≠cios</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-backup">
          <span class="opt-emoji">üíæ</span>
          <span>Backup</span>
        </button>
      </div>
      <div class="helper-text" style="margin-top:8px;">
      </div>
    </div>

    <!-- MARCA√á√ïES DE AULAS -->
    <section id="opt-reservas" class="option-section">
      <div class="card">
            <h3 style="margin-top:0; margin-bottom:8px;">üìÜ Reservas & Presen√ßas</h3>
        
            <div class="form-row">
              <div class="field">
                <label>Data da aula</label>
                <input id="reservaData" type="date" />
              </div>
              <div class="field">
                <label>Hora</label>
                <input id="reservaHora" type="time" />
              </div>
            </div>
        
            <div class="form-row">
              <div class="field">
                <label>Tipo de aula</label>
                <select id="reservaTipo">
                  <option value="">Selecionar</option>
                  <option value="WOD">WOD</option>
                  <option value="Open Box">Open Box</option>
                  <option value="Halterofilismo">Halterofilismo</option>
                  <option value="Mobilidade">Mobilidade</option>
                  <option value="Competi√ß√£o">Competi√ß√£o</option>
                </select>
              </div>
              <div class="field">
                <label>Nota (opcional)</label>
                <input id="reservaNota" type="text" placeholder="Ex.: parceiro, foco, objetivo do dia..." />
              </div>
            </div>
        
            <button class="btn-primary" id="reservaAddBtn">Guardar reserva</button>
        
            <div class="helper-text" style="margin-top:6px;">
              Estas reservas e presen√ßas s√£o pessoais e ficam apenas guardadas neste dispositivo.
            </div>
        
            <div class="scroll" style="margin-top:10px;">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Aula</th>
                    <th>Nota</th>
                    <th>Presen√ßa</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="reservasBody"></tbody>
              </table>
            </div>
        
            <div class="helper-text" id="reservasResumo" style="margin-top:6px;"></div>
      </div>
    </section>

    <!-- WOD -->
    <section id="opt-wod" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üü© WOD</h3>

        <div class="form-row">
          <div class="field">
            <label>Data</label>
            <input id="treinoData" type="date">
          </div>
          <div class="field">
            <label>Exerc√≠cio</label>
            <input id="treinoExercicioSearch" type="text" placeholder="Procurar exerc√≠cio..." />
            <select id="treinoExercicio"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo</label>
            <select id="treinoTipo">
              <option value="forca">For√ßa</option>
              <option value="metcon">Metcon</option>
              <option value="tecnica">T√©cnica</option>
              <option value="acessorio">Acess√≥rio</option>
              <option value="mobilidade">Mobilidade</option>
            </select>
          </div>
          <div class="field">
            <label>Categoria</label>
            <select id="treinoCategoria">
              <option value="peso-corporal">Peso corporal</option>
              <option value="halteres-kb">Halteres / KB</option>
              <option value="barra">Barra</option>
              <option value="cardio">Cardio</option>
              <option value="misto">Misto</option>
            </select>
          </div>
          <div class="field">
            <label>Dura√ß√£o (min)</label>
            <input id="treinoDuracao" type="number" min="1" max="240" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Carga / dist√¢ncia / tempo</label>
            <input id="treinoCarga" type="text" placeholder="Ex.: 5x5 @ 80%, 5km, EMOM 10‚Äô..." />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Notas do treino</label>
            <textarea id="treinoNotas" placeholder="Ex.: sensa√ß√£o de esfor√ßo, estrat√©gia, limita√ß√µes, etc."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Escala de esfor√ßo (RPE)</label>
            <input id="treinoRPE" type="number" min="1" max="10" placeholder="1-10" />
          </div>
          <div class="field">
            <label>Tempo / resultado</label>
            <input id="treinoResultado" type="text" placeholder="Tempo final, rondas, reps, etc." />
          </div>
        </div>

        <button class="btn-primary btn-small" id="treinoAdd">Guardar WOD</button>
        <button class="btn-secondary btn-small" id="treinoClear">Limpar campos</button>

        <div class="helper-text" style="margin-top:6px;">
          Regista os treinos para, mais tarde, conseguires ver padr√µes: dias fortes, fracos, tipo de WOD que te favorece, etc.
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Hist√≥rico de treinos</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Exerc√≠cio</th>
                <th>Categoria</th>
                <th>Resultado</th>
                <th>RPE</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="treinoTableBody"></tbody>
          </table>
        </div>
        <div class="helper-text">
          Mant√©m o teu di√°rio de treino. Pequenas notas ao longo de semanas ajudam-te a perceber como evoluis.
        </div>
      </div>
    </section>

    <!-- OBJETIVO -->
    <section id="opt-calc" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üßÆ Objetivo do dia</h3>
        <div class="form-row">
          <div class="field">
            <label>Objetivo principal</label>
            <select id="calcObjetivo">
              <option value="forca">For√ßa</option>
              <option value="hipertrofia">Hipertrofia</option>
              <option value="resistencia">Resist√™ncia</option>
              <option value="tecnica">T√©cnica</option>
              <option value="recuperacao">Recupera√ß√£o ativa</option>
            </select>
          </div>
          <div class="field">
            <label>Zona alvo (RPE)</label>
            <select id="calcRPEZona">
              <option value="leve">Leve (5-6)</option>
              <option value="moderado">Moderado (7-8)</option>
              <option value="intenso">Intenso (9-10)</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Resumo recomendado</label>
            <div id="calcResumo" class="small-text"></div>
          </div>
        </div>

        <div class="helper-text">
          Pequenos ajustes na carga, tempo e descanso ajudam a alinhar o WOD com o teu objetivo principal.
        </div>
      </div>
    </section>

    <!-- GR√ÅFICO -->
    <section id="opt-graficos" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìà Evolu√ß√£o</h3>
        <div class="form-row">
          <div class="field">
            <label>Tipo de gr√°fico</label>
            <select id="graphTipo">
              <option value="1rm">1RM</option>
              <option value="wod">WOD / RPE</option>
            </select>
          </div>
          <div class="field" id="graphExField">
            <label>Exerc√≠cio</label>
            <select id="graphExercicio"></select>
          </div>
        </div>
        <canvas id="mainChart" height="150"></canvas>
        <div class="helper-text" id="graphHelper">
          Escolhe um exerc√≠cio para veres a evolu√ß√£o do teu 1RM ao longo do tempo.
        </div>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="opt-performance" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üèÖ Desempenho geral</h3>
        <div id="performanceResumo" class="small-text"></div>
        <div class="helper-text">
          A consist√™ncia vale mais do que um treino perfeito. Procura manter um ritmo que consigas sustentar ao longo de semanas.
        </div>
      </div>
    </section>

    <!-- GUIA DE EXERC√çCIOS -->
    <section id="opt-guia" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìö Guia de exerc√≠cios</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>Tipo</th>
                <th>Categoria</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody id="guiaTableBody"></tbody>
          </table>
        </div>
        <div class="helper-text">
          Usa este guia como refer√™ncia r√°pida para escolher exerc√≠cios e variar os est√≠mulos de treino.
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="opt-backup" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üíæ Backup local</h3>
        <div class="form-row">
          <div class="field">
            <label>Exportar dados</label>
            <button class="btn-secondary btn-small" id="exportBtn">Exportar para ficheiro</button>
          </div>
          <div class="field">
            <label>Importar dados</label>
            <input id="importFile" type="file" accept=".json" />
          </div>
        </div>
        <div id="backupInfo" class="helper-text"></div>
        <div class="helper-text" style="margin-top:6px;">
          O backup √© apenas local. N√£o h√° nuvem, n√£o h√° contas. Tu controlas os teus dados.
        </div>
      </div>
    </section>

  </section>

  </div>
</div>
<script>
/* ===== CHAVES DE ARMAZENAMENTO ===== */
const STORAGE_PROFILE = "crossfit_profile";
const STORAGE_RM = "crossfit_1rm";
const STORAGE_RM_HISTORY = "crossfit_1rm_history";
const STORAGE_TREINO = "crossfit_treinos";
const STORAGE_BACKUP_META = "crossfit_backup_meta";

/* NOVOS ARMAZENAMENTOS */
const STORAGE_RESERVAS = "crossfit_reservas";
const STORAGE_PRESENCAS = "crossfit_presencas";
const STORAGE_RANKINGS = "crossfit_rankings";

/* ===== PERFIL ===== */
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const nomeEl = document.getElementById("nome");
const nivelEl = document.getElementById("nivel");
const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const boxEl = document.getElementById("box");
const objetivoPrincipalEl = document.getElementById("objetivoPrincipal");
const observacoesEl = document.getElementById("observacoes");
const appSubtitleEl = document.getElementById("appSubtitle");
const saveProfileBtn = document.getElementById("saveProfile");

/* 1RM */
let rmData = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "[]");
const rmExercicioEl = document.getElementById("rmExercicio");
const rmValorEl = document.getElementById("rmValor");
const rmAddBtn = document.getElementById("rmAdd");
const tableBody = document.getElementById("tableBody");
const rmResumoEl = document.getElementById("rmResumo");
const rmAtualCard = document.getElementById("rmAtualCard");
const rmHistoryBody = document.getElementById("rmHistoryBody");

/* WOD */
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");
const treinoDataEl = document.getElementById("treinoData");
const treinoExercicioEl = document.getElementById("treinoExercicio");
const treinoExercicioSearchEl = document.getElementById("treinoExercicioSearch");
const treinoTipoEl = document.getElementById("treinoTipo");
const treinoCategoriaEl = document.getElementById("treinoCategoria");
const treinoDuracaoEl = document.getElementById("treinoDuracao");
const treinoCargaEl = document.getElementById("treinoCarga");
const treinoNotasEl = document.getElementById("treinoNotas");
const treinoRPEEl = document.getElementById("treinoRPE");
const treinoResultadoEl = document.getElementById("treinoResultado");
const treinoAddBtn = document.getElementById("treinoAdd");
const treinoClearBtn = document.getElementById("treinoClear");
const treinoTableBody = document.getElementById("treinoTableBody");

/* Objetivo */
const calcObjetivoEl = document.getElementById("calcObjetivo");
const calcRPEZonaEl = document.getElementById("calcRPEZona");
const calcResumoEl = document.getElementById("calcResumo");

/* Gr√°ficos */
const graphTipoEl = document.getElementById("graphTipo");
const graphExercicioEl = document.getElementById("graphExercicio");
const graphExField = document.getElementById("graphExField");
const mainChartCanvas = document.getElementById("mainChart");
let mainChart = null;

/* Performance */
const performanceResumoEl = document.getElementById("performanceResumo");

/* Guia */
const guiaTableBody = document.getElementById("guiaTableBody");

/* Backup */
const exportBtn = document.getElementById("exportBtn");
const importFileInput = document.getElementById("importFile");
const backupInfoEl = document.getElementById("backupInfo");

/* Reservas & presen√ßas */
const reservaDataEl = document.getElementById("reservaData");
const reservaHoraEl = document.getElementById("reservaHora");
const reservaTipoEl = document.getElementById("reservaTipo");
const reservaNotaEl = document.getElementById("reservaNota");
const reservaAddBtn = document.getElementById("reservaAddBtn");
const reservasBody = document.getElementById("reservasBody");
const reservasResumoEl = document.getElementById("reservasResumo");

let reservas = JSON.parse(localStorage.getItem(STORAGE_RESERVAS) || "[]");
let presencas = JSON.parse(localStorage.getItem(STORAGE_PRESENCAS) || "[]");
let rankingsMensais = JSON.parse(localStorage.getItem(STORAGE_RANKINGS) || "[]");

function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

function formatKm(v) {
  return v.toFixed(2).replace(".", ",") + " km";
}

/* Selects ‚Äì 1RM s√≥ com MOVES (peso); WOD com ALL_EXERCISES */
function updateTreinoExercicioOptions(filter) {
  if (!treinoExEl) return;
  const f = (filter || "").toLowerCase();
  treinoExEl.innerHTML = "";
  ALL_EXERCISES
    .filter(ex => ex.label.toLowerCase().includes(f))
    .forEach(ex => {
      const opt = document.createElement("option");
      opt.value = ex.id;
      opt.textContent = ex.label;
      treinoExEl.appendChild(opt);
    });
}

/* MOVIMENTOS PARA 1RM ‚Äì apenas carga */
const MOVES = [
  "Back Squat",
  "Front Squat",
  "Deadlift",
  "Clean",
  "Squat Clean",
  "Power Clean",
  "Snatch",
  "Squat Snatch",
  "Power Snatch",
  "Push Press",
  "Push Jerk",
  "Split Jerk",
  "Bench Press",
  "Overhead Squat",
  "Thruster",
  "Strict Press",
  "Clean & Jerk",
  "Cluster"
];

/* TODOS OS EXERC√çCIOS ‚Äì para WOD e guia */
const ALL_EXERCISES = [
  { id: "back-squat", label: "Back Squat", tipo: "forca", categoria: "barra", notas: "Base de for√ßa pesada para pernas." },
  { id: "front-squat", label: "Front Squat", tipo: "forca", categoria: "barra", notas: "Foco em quadr√≠ceps e core, exige mobilidade." },
  { id: "deadlift", label: "Deadlift", tipo: "forca", categoria: "barra", notas: "For√ßa total, muito exigente para lombar." },
  { id: "power-clean", label: "Power Clean", tipo: "forca", categoria: "barra", notas: "Explos√£o, coordena√ß√£o e timing." },
  { id: "squat-clean", label: "Squat Clean", tipo: "forca", categoria: "barra", notas: "Clean completo, exige for√ßa e mobilidade." },
  { id: "power-snatch", label: "Power Snatch", tipo: "forca", categoria: "barra", notas: "Movimento t√©cnico de explos√£o total." },
  { id: "squat-snatch", label: "Squat Snatch", tipo: "forca", categoria: "barra", notas: "Um dos movimentos mais t√©cnicos do CrossFit." },
  { id: "push-press", label: "Push Press", tipo: "forca", categoria: "barra", notas: "For√ßa de ombros com ajuda de pernas." },
  { id: "push-jerk", label: "Push Jerk", tipo: "forca", categoria: "barra", notas: "Permite cargas mais altas que o Push Press." },
  { id: "split-jerk", label: "Split Jerk", tipo: "forca", categoria: "barra", notas: "Est√°vel para m√°ximos de carga." },
  { id: "bench-press", label: "Bench Press", tipo: "forca", categoria: "barra", notas: "Cl√°ssico para peito e tr√≠ceps." },
  { id: "oh-squat", label: "Overhead Squat", tipo: "forca", categoria: "barra", notas: "Exige muita mobilidade e estabilidade." },
  { id: "thruster", label: "Thruster", tipo: "metcon", categoria: "barra", notas: "For√ßa + cardio, muito usado em WODs." },
  { id: "strict-press", label: "Strict Press", tipo: "forca", categoria: "barra", notas: "For√ßa pura de ombros, sem ajuda de pernas." },
  { id: "clean-jerk", label: "Clean & Jerk", tipo: "forca", categoria: "barra", notas: "Levantamento ol√≠mpico completo." },
  { id: "burpee", label: "Burpee", tipo: "metcon", categoria: "peso-corporal", notas: "Cl√°ssico de cardio e mental." },
  { id: "pullup", label: "Pull-up", tipo: "forca", categoria: "peso-corporal", notas: "For√ßa de costas e bra√ßos, pode ser kipping ou estrito." },
  { id: "toes-to-bar", label: "Toes to Bar", tipo: "metcon", categoria: "peso-corporal", notas: "Core + grip, muito usado em WODs." },
  { id: "box-jump", label: "Box Jump", tipo: "metcon", categoria: "peso-corporal", notas: "Explos√£o de pernas, exige foco na rece√ß√£o." },
  { id: "row", label: "Remo (erg√≥metro)", tipo: "cardio", categoria: "cardio", notas: "Excelente para condicionamento geral." },
  { id: "bike", label: "Assault / Echo Bike", tipo: "cardio", categoria: "cardio", notas: "Cardio intenso, r√°pido a subir a frequ√™ncia card√≠aca." },
  { id: "run", label: "Corrida", tipo: "cardio", categoria: "cardio", notas: "Base de resist√™ncia, indoor ou outdoor." },
  { id: "kb-swing", label: "Kettlebell Swing", tipo: "metcon", categoria: "halteres-kb", notas: "Posterior de perna e core." },
  { id: "db-snatch", label: "Dumbbell Snatch", tipo: "metcon", categoria: "halteres-kb", notas: "Movimento unilateral explosivo." },
  { id: "db-clean-jerk", label: "DB Clean & Jerk", tipo: "metcon", categoria: "halteres-kb", notas: "Est√≠mulo semelhante ao clean & jerk com barra, mas unilateral." },
  { id: "situp", label: "Sit-up", tipo: "acessorio", categoria: "peso-corporal", notas: "Trabalho direto de core." },
  { id: "plank", label: "Plank", tipo: "acessorio", categoria: "peso-corporal", notas: "Estabilidade de core." },
  { id: "goodmorning", label: "Good Morning", tipo: "acessorio", categoria: "barra", notas: "Trabalho de cadeia posterior." },
  { id: "hip-thrust", label: "Hip Thrust", tipo: "acessorio", categoria: "barra", notas: "Foco em gl√∫teos." },
  { id: "band-pullapart", label: "Band Pull-apart", tipo: "acessorio", categoria: "acessorio", notas: "Sa√∫de dos ombros e postura." },
  { id: "facepull", label: "Face Pull", tipo: "acessorio", categoria: "acessorio", notas: "Parte superior das costas e ombros." }
];

/* Percentagens usadas para 1RM (inclui 65%) */
const PERC = [
  0.25, 0.30, 0.35, 0.40,
  0.50, 0.60, 0.65, 0.70,
  0.75, 0.80, 0.85, 0.90,
  0.95
];

/* ===== PERFIL ‚Äì carregar / guardar ===== */
function loadProfile() {
  if (!profile) return;
  nomeEl.value = profile.nome || "";
  nivelEl.value = profile.nivel || "";
  sexoEl.value = profile.sexo || "";
  idadeEl.value = profile.idade || "";
  alturaEl.value = profile.altura || "";
  pesoEl.value = profile.peso || "";
  boxEl.value = profile.box || "";
  objetivoPrincipalEl.value = profile.objetivoPrincipal || "";
  observacoesEl.value = profile.observacoes || "";

  if (profile.nome) {
    appSubtitleEl.textContent = `Registo de treinos de ${profile.nome}`;
  } else {
    appSubtitleEl.textContent = "Registo de treinos";
  }
}

function saveProfile() {
  profile = {
    nome: nomeEl.value.trim(),
    nivel: nivelEl.value,
    sexo: sexoEl.value,
    idade: idadeEl.value ? parseInt(idadeEl.value, 10) : null,
    altura: alturaEl.value ? parseInt(alturaEl.value, 10) : null,
    peso: pesoEl.value ? parseFloat(pesoEl.value) : null,
    box: boxEl.value.trim(),
    objetivoPrincipal: objetivoPrincipalEl.value.trim(),
    observacoes: observacoesEl.value.trim()
  };
  localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
  loadProfile();
}

/* ===== 1RM ===== */
function renderRm() {
  tableBody.innerHTML = "";
  const entries = Object.entries(rmData);
  if (!entries.length) {
    rmResumoEl.textContent = "Ainda n√£o registaste nenhum 1RM.";
    rmAtualCard.style.display = "none";
    return;
  }

  rmAtualCard.style.display = "block";

  let total = 0;
  let count = 0;
  let resumo = [];

  entries.forEach(([ex, obj]) => {
    const tr = document.createElement("tr");
    const tdEx = document.createElement("td");
    tdEx.textContent = ex;

    const tdRm = document.createElement("td");
    tdRm.textContent = formatKg(obj.rm);

    tr.appendChild(tdEx);
    tr.appendChild(tdRm);

    PERC.forEach(p => {
      const td = document.createElement("td");
      td.textContent = formatKg(obj.rm * p);
      tr.appendChild(td);
    });

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.textContent = "x";
    btnDel.className = "btn-small btn-danger";
    btnDel.addEventListener("click", () => {
      delete rmData[ex];
      localStorage.setItem(STORAGE_RM, JSON.stringify(rmData));
      renderRm();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    tableBody.appendChild(tr);

    total += obj.rm;
    count++;
    resumo.push(`${ex}: ${formatKg(obj.rm)}`);
  });

  if (count > 0) {
    const media = total / count;
    rmResumoEl.textContent = `Tens 1RM registado em ${count} movimentos. M√©dia aproximada: ${formatKg(media)}. | ${resumo.join(" ¬∑ ")}`;
  } else {
    rmResumoEl.textContent = "Ainda n√£o registaste nenhum 1RM.";
  }
}

function addRm() {
  const exercicio = rmExercicioEl.value;
  const valor = parseFloat(rmValorEl.value);
  if (!exercicio || !valor || valor <= 0) return;

  const data = new Date().toISOString().slice(0, 10);

  rmData[exercicio] = { rm: valor, data };
  localStorage.setItem(STORAGE_RM, JSON.stringify(rmData));

  rmHistory.push({
    data,
    exercicio,
    rm: valor,
    comentario: ""
  });
  localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));

  rmValorEl.value = "";
  renderRm();
  renderRmHistory();
}

function renderRmHistory() {
  rmHistoryBody.innerHTML = "";
  if (!rmHistory.length) return;

  const sorted = [...rmHistory].sort((a, b) => a.data.localeCompare(b.data));

  sorted.forEach((entry, idx) => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = entry.data || "";
    tr.appendChild(tdData);

    const tdEx = document.createElement("td");
    tdEx.textContent = entry.exercicio || "";
    tr.appendChild(tdEx);

    const tdRm = document.createElement("td");
    tdRm.textContent = entry.rm ? formatKg(entry.rm) : "";
    tr.appendChild(tdRm);

    const tdComent = document.createElement("td");
    tdComent.textContent = entry.comentario || "";
    tr.appendChild(tdComent);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.textContent = "x";
    btnDel.className = "btn-small btn-danger";
    btnDel.addEventListener("click", () => {
      rmHistory.splice(idx, 1);
      localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
      renderRmHistory();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    rmHistoryBody.appendChild(tr);
  });
}

/* ===== WOD ===== */
function renderTreinos() {
  treinoTableBody.innerHTML = "";
  if (!treinos.length) return;

  const sorted = [...treinos].sort((a, b) => (a.data || "").localeCompare(b.data || ""));

  sorted.forEach((t, idx) => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = t.data || "";
    tr.appendChild(tdData);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdEx = document.createElement("td");
    tdEx.textContent = t.exercicio || "";
    tr.appendChild(tdEx);

    const tdCat = document.createElement("td");
    tdCat.textContent = t.categoria || "";
    tr.appendChild(tdCat);

    const tdRes = document.createElement("td");
    tdRes.textContent = t.resultado || "";
    tr.appendChild(tdRes);

    const tdRpe = document.createElement("td");
    tdRpe.textContent = t.rpe || "";
    tr.appendChild(tdRpe);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.textContent = "x";
    btnDel.className = "btn-small btn-danger";
    btnDel.addEventListener("click", () => {
      treinos.splice(idx, 1);
      localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
      renderTreinos();
      updatePerformance();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    treinoTableBody.appendChild(tr);
  });
}

function clearTreinoForm() {
  treinoDataEl.value = "";
  treinoExercicioSearchEl.value = "";
  treinoTipoEl.value = "forca";
  treinoCategoriaEl.value = "peso-corporal";
  treinoDuracaoEl.value = "";
  treinoCargaEl.value = "";
  treinoNotasEl.value = "";
  treinoRPEEl.value = "";
  treinoResultadoEl.value = "";
  updateTreinoExercicioOptions("");
}

function addTreino() {
  const data = treinoDataEl.value || new Date().toISOString().slice(0, 10);
  const exSel = treinoExercicioEl.value;
  const exObj = ALL_EXERCISES.find(e => e.id === exSel);
  const exercicio = exObj ? exObj.label : (treinoExercicioSearchEl.value || "Sem nome");
  const tipo = treinoTipoEl.value;
  const categoria = treinoCategoriaEl.value;
  const duracao = treinoDuracaoEl.value ? parseInt(treinoDuracaoEl.value, 10) : null;
  const carga = treinoCargaEl.value.trim();
  const notas = treinoNotasEl.value.trim();
  const rpe = treinoRPEEl.value ? parseInt(treinoRPEEl.value, 10) : null;
  const resultado = treinoResultadoEl.value.trim();

  treinos.push({
    data,
    exercicio,
    tipo,
    categoria,
    duracao,
    carga,
    notas,
    rpe,
    resultado
  });

  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
  renderTreinos();
  updatePerformance();
}

/* ===== OBJETIVO ===== */
function updateObjetivoResumo() {
  const obj = calcObjetivoEl.value;
  const zona = calcRPEZonaEl.value;

  let txt = "";

  if (obj === "forca") {
    txt += "Foca-te em s√©ries curtas (1-5 reps) com carga alta e descansos mais longos. ";
  } else if (obj === "hipertrofia") {
    txt += "Trabalha em s√©ries de 6-12 reps, com ritmo controlado e descanso moderado. ";
  } else if (obj === "resistencia") {
    txt += "Privilegia metcons mais longos, com gest√£o de ritmo e movimentos c√≠clicos. ";
  } else if (obj === "tecnica") {
    txt += "Reduz a carga, aumenta a qualidade do movimento e a consci√™ncia corporal. ";
  } else if (obj === "recuperacao") {
    txt += "Mant√©m intensidade baixa, movimentos flu√≠dos e foco em mobilidade. ";
  }

  if (zona === "leve") {
    txt += "Hoje o foco √© leve (RPE 5-6): sai a suar, mas sem ir ao limite.";
  } else if (zona === "moderado") {
    txt += "Hoje o foco √© moderado (RPE 7-8): esfor√ßo s√≥lido, mas ainda controlado.";
  } else if (zona === "intenso") {
    txt += "Hoje o foco √© intenso (RPE 9-10): prepara-te para dar quase tudo.";
  }

  calcResumoEl.textContent = txt;
}

/* ===== GR√ÅFICOS ===== */
function updateGraphOptions() {
  const tipo = graphTipoEl.value;
  if (tipo === "1rm") {
    graphExField.style.display = "block";
    graphExercicioEl.innerHTML = "";
    MOVES.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      graphExercicioEl.appendChild(opt);
    });
  } else {
    graphExField.style.display = "none";
  }
}

function buildChartData() {
  const tipo = graphTipoEl.value;
  if (tipo === "1rm") {
    const ex = graphExercicioEl.value;
    const history = rmHistory.filter(h => h.exercicio === ex).sort((a, b) => a.data.localeCompare(b.data));
    return {
      labels: history.map(h => h.data),
      data: history.map(h => h.rm || 0),
      label: ex
    };
  } else {
    const sorted = [...treinos].sort((a, b) => (a.data || "").localeCompare(b.data || ""));
    return {
      labels: sorted.map(t => t.data || ""),
      data: sorted.map(t => t.rpe || 0),
      label: "RPE"
    };
  }
}

function renderChart() {
  const { labels, data, label } = buildChartData();
  if (mainChart) {
    mainChart.destroy();
  }

  mainChart = new Chart(mainChartCanvas, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label,
        data
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

/* ===== PERFORMANCE ===== */
function updatePerformance() {
  if (!treinos.length) {
    performanceResumoEl.textContent = "Ainda n√£o h√° treinos registados.";
    return;
  }

  const totalTreinos = treinos.length;

  const porTipo = treinos.reduce((acc, t) => {
    acc[t.tipo] = (acc[t.tipo] || 0) + 1;
    return acc;
  }, {});

  const mediaRPE = treinos
    .map(t => t.rpe || 0)
    .filter(v => v > 0)
    .reduce((acc, v, _, arr) => acc + v / arr.length, 0);

  const diasUnicos = new Set(treinos.map(t => t.data || ""));

  const resumoTipos = Object.entries(porTipo)
    .map(([tipo, qtd]) => `${tipo}: ${qtd}`)
    .join(" ¬∑ ");

  performanceResumoEl.textContent =
    `Treinos registados: ${totalTreinos}. Dias √∫nicos com treino: ${diasUnicos.size}. ` +
    (mediaRPE ? `RPE m√©dio aproximado: ${mediaRPE.toFixed(1)}. ` : "") +
    (resumoTipos ? `Distribui√ß√£o por tipo ‚Äì ${resumoTipos}.` : "");
}

/* ===== GUIA ===== */
function renderGuia() {
  guiaTableBody.innerHTML = "";
  ALL_EXERCISES.forEach(ex => {
    const tr = document.createElement("tr");

    const tdNome = document.createElement("td");
    tdNome.textContent = ex.label;
    tr.appendChild(tdNome);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = ex.tipo;
    tr.appendChild(tdTipo);

    const tdCat = document.createElement("td");
    tdCat.textContent = ex.categoria;
    tr.appendChild(tdCat);

    const tdNotas = document.createElement("td");
    tdNotas.textContent = ex.notas;
    tr.appendChild(tdNotas);

    guiaTableBody.appendChild(tr);
  });
}

/* ===== BACKUP ===== */
function exportData() {
  const data = {
    profile,
    rmData,
    rmHistory,
    treinos,
    reservas,
    presencas,
    rankingsMensais,
    meta: {
      createdAt: new Date().toISOString(),
      app: "Cross Moita - Di√°rio de Treino Offline"
    }
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "crossbox_backup.json";
  a.click();
  URL.revokeObjectURL(url);

  backupInfoEl.textContent = "Backup exportado com sucesso.";
}

function importData(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.profile) {
        profile = data.profile;
        localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
      }
      if (data.rmData) {
        rmData = data.rmData;
        localStorage.setItem(STORAGE_RM, JSON.stringify(rmData));
      }
      if (data.rmHistory) {
        rmHistory = data.rmHistory;
        localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
      }
      if (data.treinos) {
        treinos = data.treinos;
        localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
      }
      if (data.reservas) {
        reservas = data.reservas;
        localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
      }
      if (data.presencas) {
        presencas = data.presencas;
        localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
      }
      if (data.rankingsMensais) {
        rankingsMensais = data.rankingsMensais;
        localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));
      }

      loadProfile();
      renderRm();
      renderRmHistory();
      renderTreinos();
      renderReservas();
      updatePerformance();
      renderGuia();
      backupInfoEl.textContent = "Backup importado com sucesso.";
    } catch (err) {
      backupInfoEl.textContent = "Erro ao importar backup.";
    }
  };
  reader.readAsText(file);
}

/* ===== RESERVAS & PRESEN√áAS ===== */
function renderReservas() {
  reservasBody.innerHTML = "";
  if (!reservas.length) {
    reservasResumoEl.textContent = "Ainda n√£o h√° reservas registadas.";
    return;
  }

  const sorted = [...reservas].sort((a, b) => (a.data || "").localeCompare(b.data || ""));

  let totalPresencas = 0;

  sorted.forEach((r, idx) => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = r.data || "";
    tr.appendChild(tdData);

    const tdHora = document.createElement("td");
    tdHora.textContent = r.hora || "";
    tr.appendChild(tdHora);

    const tdAula = document.createElement("td");
    tdAula.textContent = r.tipo || "";
    tr.appendChild(tdAula);

    const tdNota = document.createElement("td");
    tdNota.textContent = r.nota || "";
    tr.appendChild(tdNota);

    const tdPres = document.createElement("td");
    const check = document.createElement("input");
    check.type = "checkbox";
    check.checked = !!r.presenca;
    check.addEventListener("change", () => {
      r.presenca = check.checked;
      localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
      renderReservas();
    });
    tdPres.appendChild(check);
    tr.appendChild(tdPres);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.textContent = "x";
    btnDel.className = "btn-small btn-danger";
    btnDel.addEventListener("click", () => {
      reservas.splice(idx, 1);
      localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
      renderReservas();
    });
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    reservasBody.appendChild(tr);

    if (r.presenca) totalPresencas++;
  });

  reservasResumoEl.textContent =
    `Reservas registadas: ${reservas.length}. Presen√ßas assinaladas: ${totalPresencas}.`;
}

function addReserva() {
  const data = reservaDataEl.value || new Date().toISOString().slice(0, 10);
  const hora = reservaHoraEl.value || "";
  const tipo = reservaTipoEl.value || "";
  const nota = reservaNotaEl.value.trim();

  reservas.push({
    data,
    hora,
    tipo,
    nota,
    presenca: false
  });

  localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
  renderReservas();

  reservaDataEl.value = "";
  reservaHoraEl.value = "";
  reservaTipoEl.value = "";
  reservaNotaEl.value = "";
}

/* ===== EVENTOS ===== */
saveProfileBtn.addEventListener("click", saveProfile);

rmAddBtn.addEventListener("click", addRm);

treinoAddBtn.addEventListener("click", addTreino);
treinoClearBtn.addEventListener("click", clearTreinoForm);

calcObjetivoEl.addEventListener("change", updateObjetivoResumo);
calcRPEZonaEl.addEventListener("change", updateObjetivoResumo);

graphTipoEl.addEventListener("change", () => {
  updateGraphOptions();
  renderChart();
});
graphExercicioEl.addEventListener("change", renderChart);

exportBtn.addEventListener("click", exportData);
importFileInput.addEventListener("change", () => {
  if (importFileInput.files && importFileInput.files[0]) {
    importData(importFileInput.files[0]);
  }
});

treinoExercicioSearchEl.addEventListener("input", () => {
  updateTreinoExercicioOptions(treinoExercicioSearchEl.value);
});

reservaAddBtn.addEventListener("click", addReserva);

/* ===== TABS ===== */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

/* OP√á√ïES (sub-se√ß√µes) */
document.querySelectorAll(".opt-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    document.querySelectorAll(".option-section").forEach(s => s.classList.remove("active"));
    const sec = document.getElementById(target);
    if (sec) sec.classList.add("active");
  });
});

/* INIT */
initSelects();
loadProfile();
renderRm();
renderRmHistory();
renderTreinos();
renderReservas();
updatePerformance();
renderGuia();
updateObjetivoResumo();
updateGraphOptions();
renderChart();

/* DATA DO WOD POR OMISS√ÉO */
if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
</script>
</body>
</html>
